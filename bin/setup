#!/usr/bin/env ruby
# frozen_string_literal: true

require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(cmd)
  puts "==> Running: #{cmd}"
  system(cmd) || abort("\n== Command failed: #{cmd} ==")
end

def command_does_not_exist?(cmd)
  !system("command -v #{cmd} >/dev/null 2>&1")
end

def abort_missing(cmd, instructions)
  abort("\n== Missing required dependency: #{cmd} ==\n#{instructions}\n")
end

def login_shell
  File.basename(ENV["SHELL"].to_s)
end

def shell_rc_file
  case login_shell
  when "zsh"
    File.join(Dir.home, ".zshrc")
  when "bash"
    bashrc = File.join(Dir.home, ".bashrc")
    File.exist?(bashrc) ? bashrc : File.join(Dir.home, ".bash_profile")
  else
    nil
  end
end

FileUtils.chdir(APP_ROOT) do
  puts "\n== 0. Checking prerequisites =="

  if command_does_not_exist?("brew")
    abort_missing("Homebrew", "Install Homebrew first: https://brew.sh/")
  end

  if command_does_not_exist?("docker")
    abort_missing("Docker", "Install Docker: https://docs.docker.com/get-docker/")
  end

  # Warn if rbenv is active (PATH conflict)
  rbenv_active =
    ENV.key?("RBENV_ROOT") ||
    ENV["PATH"].split(":").any? { |p| p.include?(".rbenv/shims") }

  if rbenv_active
    puts <<~WARN

      ⚠️  rbenv appears to be active in your shell.

      This project uses mise to manage Ruby and Node versions.
      If you encounter Ruby or Bundler issues, ensure rbenv
      is not taking precedence over mise in your PATH.

      Recommended:
        - Comment out `eval "$(rbenv init -)"` in your shell config
        - Restart your shell
        - Re-run ./bin/setup

    WARN
  end

  # Ruby gem bin PATH warning (Homebrew Ruby)
  ruby_gem_bin = "/opt/homebrew/lib/ruby/gems/3.4.0/bin"
  unless ENV["PATH"].split(":").include?(ruby_gem_bin)
    puts <<~WARN

      ⚠️  Ruby gem binaries directory is not on PATH.

      Add this to your shell config if you see Bundler or gem command issues:
        export PATH="#{ruby_gem_bin}:$PATH"

    WARN
  end

  puts "\n== 1. Copying dotenv to .env =="
  if !File.exist?(".env") && File.exist?("dotenv")
    FileUtils.cp("dotenv", ".env")
    puts "Copied dotenv -> .env"
  end

  puts "\n== 2. Installing and configuring mise =="

  if command_does_not_exist?("mise")
    system!("brew install mise")
  else
    puts "mise already installed"
  end

  rc_file = shell_rc_file
  activation_line = 'eval "$(mise activate)"'

  if rc_file.nil?
    puts <<~WARN

      ⚠️  Could not determine shell config file for shell: #{login_shell}

      To activate mise manually, add this to your shell config:
        #{activation_line}

    WARN
  else
    if File.exist?(rc_file) && File.read(rc_file).include?("mise activate")
      puts "mise already activated in #{rc_file}"
    else
      File.open(rc_file, "a") do |f|
        f.puts
        f.puts "# mise version manager"
        f.puts activation_line
      end
      puts "Added mise activation to #{rc_file}"
      puts "Restart your shell after setup completes."
    end
  end

  puts "\n== 3. Installing runtimes via mise =="
  system!("mise install")

  # --- Node 20 is selected ---
  puts "\n== Selecting Node 20 via mise =="
  system!("mise use nodejs@20 --quiet")

  puts "\n== 4. Verifying Node version =="
  expected_node_major = "20"
  actual_node = `node -v`.strip rescue nil

  if actual_node.nil? || !actual_node.start_with?("v#{expected_node_major}.")
    abort <<~MSG

      == Node version mismatch ==
      Expected Node #{expected_node_major}.x
      Found: #{actual_node || "not installed"}

      Fix with:
        restart your shell
        mise install
        mise use nodejs@20

    MSG
  end

  puts "\n== 5. Installing Bundler =="
  bundler_version = File.read("Gemfile.lock").lines.last.strip

  if `gem list -i bundler -v #{bundler_version}`.strip == "true"
    puts "Bundler #{bundler_version} already installed"
  else
    system!("gem install bundler:#{bundler_version}")
  end

  puts "\n== 6. Installing Ruby dependencies =="
  system("bundle check") || system!("bundle install")

  puts "\n== 7. Installing Yarn dependencies =="
  system!("yarn install --check-files")

  puts "\n== 8. Starting database via Docker =="
  system!("docker compose pull wrsat-db")
  system!("docker compose up --wait -d wrsat-db")

  puts "\n== 9. Preparing database =="
  system!("bin/rails db:prepare")

  puts "\n== 10. Clearing logs and temp files =="
  system!("bin/rails log:clear tmp:clear")

  if ARGV.include?("--skip-server")
    puts "\n== Setup complete (server skipped) =="
  else
    puts "\n== 11. Starting development server =="
    STDOUT.flush
    exec "bin/dev"
  end
end