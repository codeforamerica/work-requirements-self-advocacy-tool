#!/usr/bin/env ruby
# frozen_string_literal: true

require "fileutils"

APP_ROOT = File.expand_path("..", __dir__)

def system!(cmd)
  puts "==> Running: #{cmd}"
  system(cmd) || abort("\n== Command failed: #{cmd} ==")
end

def command_does_not_exist?(cmd)
  !system("command -v #{cmd} >/dev/null 2>&1")
end

def abort_missing(cmd, instructions)
  abort("\n== Missing required dependency: #{cmd} ==\n#{instructions}\n")
end

def login_shell
  File.basename(ENV["SHELL"].to_s)
end

def shell_rc_file
  case login_shell
  when "zsh"
    File.join(Dir.home, ".zshrc")
  when "bash"
    bashrc = File.join(Dir.home, ".bashrc")
    File.exist?(bashrc) ? bashrc : File.join(Dir.home, ".bash_profile")
  else
    nil
  end
end

def expected_node_version
  # Try .tool-versions first
  tool_versions_file = File.join(APP_ROOT, ".tool-versions")
  if File.exist?(tool_versions_file)
    line = File.readlines(tool_versions_file).find { |l| l.start_with?("nodejs") }
    return line.strip.split(" ")[1] if line
  end

  # fallback to .node-version
  node_file = File.join(APP_ROOT, ".node-version")
  return File.read(node_file).strip if File.exist?(node_file)

  # final fallback
  "20.0.0"
end

def expected_ruby_version
  ruby_file = File.join(APP_ROOT, ".ruby-version")
  if File.exist?(ruby_file)
    File.read(ruby_file).strip
  else
    nil
  end
end

FileUtils.chdir(APP_ROOT) do
  puts "\n== 0. Checking prerequisites =="

  if command_does_not_exist?("brew")
    abort_missing("Homebrew", "Install Homebrew first: https://brew.sh/")
  end

  if command_does_not_exist?("docker")
    abort_missing("Docker", "Install Docker: https://docs.docker.com/get-docker/")
  end

  # Warn if rbenv is active (PATH conflict)
  rbenv_active =
    ENV.key?("RBENV_ROOT") ||
    ENV["PATH"].split(":").any? { |p| p.include?(".rbenv/shims") }

  if rbenv_active
    puts <<~WARN

      ⚠️  rbenv appears to be active in your shell.

      This project uses mise to manage Ruby and Node versions.
      If you encounter Ruby or Bundler issues, ensure rbenv
      is not taking precedence over mise in your PATH.

      Recommended:
        - Comment out `eval "$(rbenv init -)"` in your shell config
        - Restart your shell
        - Re-run ./bin/setup

    WARN
  end

  # Ruby gem bin PATH warning (Homebrew Ruby)
  ruby_gem_bin = "/opt/homebrew/lib/ruby/gems/3.4.0/bin"
  if ENV["PATH"].split(":").none? { |p| p == ruby_gem_bin }
    puts <<~WARN

      ⚠️  Ruby gem binaries directory is not on PATH.

      Add this to your shell config if you see Bundler or gem command issues:
        export PATH="#{ruby_gem_bin}:$PATH"

    WARN
  end

  puts "\n== 1. Copying dotenv to .env =="
  if !File.exist?(".env") && File.exist?("dotenv")
    FileUtils.cp("dotenv", ".env")
    puts "Copied dotenv -> .env"
  end

  puts "\n== 2. Installing and configuring mise =="

  if command_does_not_exist?("mise")
    system!("brew install mise")
  else
    puts "mise already installed"
  end

  rc_file = shell_rc_file
  activation_line = 'eval "$(mise activate)"'

  if rc_file.nil?
    puts <<~WARN

      ⚠️  Could not determine shell config file for shell: #{login_shell}

      To activate mise manually, add this to your shell config:
        #{activation_line}

    WARN
  else
    if File.exist?(rc_file) && File.read(rc_file).include?("mise activate")
      puts "mise already activated in #{rc_file}"
    else
      File.open(rc_file, "a") do |f|
        f.puts
        f.puts "# mise version manager"
        f.puts activation_line
      end
      puts "Added mise activation to #{rc_file}"
      puts "Restart your shell after setup completes."
    end
  end

  puts "\n== 3. Installing runtimes via mise =="
  system!("mise install")

  # --- Explicitly select Node and Ruby versions ---
  node_version = expected_node_version
  puts "\n== Selecting Node #{node_version} via mise =="
  system!("mise use nodejs@#{node_version} --quiet")

  ruby_version = expected_ruby_version
  if ruby_version
    puts "\n== Selecting Ruby #{ruby_version} via mise =="
    system!("mise use ruby@#{ruby_version} --quiet")
  end

  # --- Verify Node version ---
  actual_node = `node -v`.strip rescue nil
  node_major = node_version.split(".").first
  if actual_node.nil? || !actual_node.start_with?("v#{node_major}.")
    abort <<~MSG

      == Node version mismatch ==
      Expected Node #{node_version}
      Found: #{actual_node || "not installed"}

      Fix with:
        restart your shell
        mise install
        mise use

    MSG
  else
    puts "Node version #{actual_node} OK"
  end

  # --- Verify Ruby version ---
  if ruby_version
    actual_ruby = `ruby -v`.strip rescue nil
    if actual_ruby.nil? || !actual_ruby.start_with?("ruby #{ruby_version}")
      abort <<~MSG

        == Ruby version mismatch ==
        Expected Ruby #{ruby_version}
        Found: #{actual_ruby || "not installed"}

        Fix with:
          restart your shell
          mise install
          mise use

      MSG
    else
      puts "Ruby version #{actual_ruby} OK"
    end
  end

  puts "\n== 4. Installing Bundler =="
  bundler_version = File.read("Gemfile.lock").lines.last.strip
  if `gem list -i bundler -v #{bundler_version}`.strip == "true"
    puts "Bundler #{bundler_version} already installed"
  else
    system!("gem install bundler:#{bundler_version}")
  end

  puts "\n== 5. Installing Ruby dependencies =="
  system("bundle check") || system!("bundle install")

  puts "\n== 6. Installing Yarn dependencies =="
  system!("yarn install --check-files")

  puts "\n== 7. Starting database via Docker =="
  system!("docker compose pull wrsat-db")
  system!("docker compose up --wait -d wrsat-db")

  puts "\n== 8. Preparing database =="
  system!("bin/rails db:prepare")

  puts "\n== 9. Clearing logs and temp files =="
  system!("bin/rails log:clear tmp:clear")

  if ARGV.include?("--skip-server")
    puts "\n== Setup complete (server skipped) =="
  else
    puts "\n== 10. Starting development server =="
    STDOUT.flush
    exec "bin/dev"
  end
end